var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.Compose=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireDefault(require("react"));var _components=require("../../../components");var _reactNative=require("react-native");var _queries=require("../../../queries");var _reactHooks=require("@apollo/react-hooks");var _theme=require("../../../theme");var _state=require("../../../state");var _fns=require("../../../fns");var _ComposeToolbar=_interopRequireDefault(require("../ComposeToolbar"));var _ComposeBody=_interopRequireDefault(require("../ComposeBody"));var _ComposeTitle=_interopRequireDefault(require("../ComposeTitle"));var _this=this,_jsxFileName="/Users/kane/Lab/Eros/src/containers/Compose/Compose/index.js";var SET_TYPE=_state.ComposeActions.SET_TYPE,SET_INDEX=_state.ComposeActions.SET_INDEX,SET_CONTENT=_state.ComposeActions.SET_CONTENT,SET_TITLE=_state.ComposeActions.SET_TITLE,RESET=_state.ComposeActions.RESET;var filterEmptyContent=function filterEmptyContent(contentBlock){if(contentBlock.type==='Text'&&contentBlock.text===''){return false;}return true;};var formatContentForGraph=function formatContentForGraph(content){var contentArray=Object.entries(content).reduce(function(acc,_ref){var _ref2=(0,_slicedToArray2.default)(_ref,2),index=_ref2[0],contentBlock=_ref2[1];if(contentBlock.type==='Image'){return[].concat((0,_toConsumableArray2.default)(acc),[{index:parseInt(index,10),type:contentBlock.type,files:contentBlock.files}]);}return[].concat((0,_toConsumableArray2.default)(acc),[(0,_extends2.default)({index:parseInt(index,10)},contentBlock)]);},[]).filter(filterEmptyContent);return contentArray;};var Compose=function Compose(_ref3){var _ref3$onSuccess=_ref3.onSuccess,onSuccess=_ref3$onSuccess===void 0?function(){return null;}:_ref3$onSuccess;var styles=useStyles();var _useDimensions=(0,_state.useDimensions)(),mobile=_useDimensions.mobile;var _useCompose=(0,_state.useCompose)(),_useCompose2=(0,_slicedToArray2.default)(_useCompose,2),state=_useCompose2[0],dispatch=_useCompose2[1];var _useMutation=(0,_reactHooks.useMutation)(_queries.CREATE_POST),_useMutation2=(0,_slicedToArray2.default)(_useMutation,2),createPost=_useMutation2[0],_useMutation2$=_useMutation2[1],error=_useMutation2$.error,loading=_useMutation2$.loading;var _useMutation3=(0,_reactHooks.useMutation)(_queries.CREATE_PRESIGNED_URL),_useMutation4=(0,_slicedToArray2.default)(_useMutation3,1),createPresignedUrl=_useMutation4[0];var signFiles=function signFiles(files){return Promise.all(files.map(function(file){return(0,_fns.signFile)(file)(createPresignedUrl);}));};var onFiles=function onFiles(nextFiles){var nextIndex,signedFiles,contentBlockImage,newTextBlock;return _regenerator.default.async(function onFiles$(_context){while(1){switch(_context.prev=_context.next){case 0:dispatch({type:SET_TYPE,payload:'Image'});nextIndex=state.activeIndex+1;dispatch({type:SET_INDEX,payload:nextIndex});console.log('nextFiles',nextFiles);_context.next=6;return _regenerator.default.awrap((0,_fns.convertFilesToBase64)(nextFiles));case 6:console.log('nextFiles',nextFiles);_context.next=9;return _regenerator.default.awrap(signFiles(nextFiles));case 9:signedFiles=_context.sent;console.log('signedFiles',signedFiles);contentBlockImage={index:nextIndex,data:{index:nextIndex,type:'Image',files:signedFiles}};dispatch({type:SET_CONTENT,payload:contentBlockImage});newTextBlock={index:nextIndex+1,data:{index:nextIndex+1,type:'Text',text:''}};dispatch({type:SET_CONTENT,payload:newTextBlock});dispatch({type:SET_TYPE,payload:'Text'});dispatch({type:SET_INDEX,payload:nextIndex+1});case 17:case"end":return _context.stop();}}},null,null,null,Promise);};var title=state.title,friendlyUrl=state.friendlyUrl,content=state.content;var onSubmit=function onSubmit(){var contentArray,input,_await$createPost,data;return _regenerator.default.async(function onSubmit$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;contentArray=formatContentForGraph(content);console.log({contentArray:contentArray});input={content:contentArray,title:title,friendlyUrl:friendlyUrl};_context2.next=6;return _regenerator.default.awrap(createPost({variables:{input:input}}));case 6:_await$createPost=_context2.sent;data=_await$createPost.data;if(data&&data.CreatePost){dispatch({type:RESET});onSuccess(data.CreatePost);}_context2.next=14;break;case 11:_context2.prev=11;_context2.t0=_context2["catch"](0);console.log('createPostError',_context2.t0);case 14:case"end":return _context2.stop();}}},null,null,[[0,11]],Promise);};var setTitle=function setTitle(title){return dispatch({type:SET_TITLE,payload:title});};return _react.default.createElement(_react.default.Fragment,null,_react.default.createElement(_components.NavMutatingScroll,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:102,columnNumber:7}},_react.default.createElement(_components.NavPlaceholder,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:103,columnNumber:9}}),_react.default.createElement(_components.View,{style:styles.container,__self:_this,__source:{fileName:_jsxFileName,lineNumber:104,columnNumber:9}},_react.default.createElement(_components.View,{style:styles.contentContainer,__self:_this,__source:{fileName:_jsxFileName,lineNumber:105,columnNumber:11}},_react.default.createElement(_components.Container,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:106,columnNumber:13}},_react.default.createElement(_ComposeTitle.default,{title:state.title,setTitle:setTitle,__self:_this,__source:{fileName:_jsxFileName,lineNumber:107,columnNumber:15}}),_react.default.createElement(_ComposeBody.default,{state:state,dispatch:dispatch,__self:_this,__source:{fileName:_jsxFileName,lineNumber:108,columnNumber:15}})),_react.default.createElement(_ComposeToolbar.default,{loading:loading,mobile:mobile,onFiles:onFiles,onSubmit:onSubmit,urlPreview:state.friendlyUrl,__self:_this,__source:{fileName:_jsxFileName,lineNumber:110,columnNumber:13}})))));};exports.Compose=Compose;var useStyles=(0,_theme.makeStyles)(function(theme){return{container:{width:'100%',height:'100%',alignItems:'center',paddingBottom:48,flex:1},contentContainer:{maxWidth:theme.FEED_WIDTH,width:'100%',height:'100%',flex:1}};});var _default=Compose;exports.default=_default;