var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _react=_interopRequireWildcard(require("react"));var _reactHooks=require("@apollo/react-hooks");var _state=require("../../state");var _queries=require("../../queries");var _=require("../..");var _ComposeToolbar=_interopRequireDefault(require("./ComposeToolbar"));var _ComposeBody=_interopRequireDefault(require("./ComposeBody"));var _fns=require("../../fns");var _this=this,_jsxFileName="/Users/kane/Lab/Eros/src/containers/Compose/ComposeModal.js";var uploadImage=function uploadImage(file){var response;return _regenerator.default.async(function uploadImage$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _regenerator.default.awrap(fetch(file.presignedUrl,{method:'PUT',headers:{'Content-Type':'multipart/form-data'},body:file}));case 3:response=_context.sent;console.log({response:response});if(!(response.status===200)){_context.next=7;break;}return _context.abrupt("return",response.url);case 7:return _context.abrupt("return",null);case 10:_context.prev=10;_context.t0=_context["catch"](0);console.log(_context.t0);return _context.abrupt("return",null);case 14:case"end":return _context.stop();}}},null,null,[[0,10]],Promise);};var uploadImages=function uploadImages(files){return Promise.all(files.map(uploadImage));};var contentMediaFilter=function contentMediaFilter(content){if((content==null?void 0:content.type)==='Image'){return true;}if((content==null?void 0:content.type)==='Video'){return true;}};var ComposeModal=function ComposeModal(){var _data$ComposeModal;var _useQuery=(0,_reactHooks.useQuery)(_queries.COMPOSE_MODAL),data=_useQuery.data;var _useMutation=(0,_reactHooks.useMutation)(_queries.TOGGLE_COMPOSE_MODAL),_useMutation2=(0,_slicedToArray2.default)(_useMutation,1),toggleComposeModal=_useMutation2[0];var _useCompose=(0,_state.useCompose)(),_useCompose2=(0,_slicedToArray2.default)(_useCompose,2),state=_useCompose2[0],dispatch=_useCompose2[1];var _useMutation3=(0,_reactHooks.useMutation)(_queries.CREATE_POST),_useMutation4=(0,_slicedToArray2.default)(_useMutation3,1),createPost=_useMutation4[0];var _useState=(0,_react.useState)(null),_useState2=(0,_slicedToArray2.default)(_useState,2),loadingPercent=_useState2[0],setLoadingPercent=_useState2[1];var open=data==null?void 0:(_data$ComposeModal=data.ComposeModal)==null?void 0:_data$ComposeModal.open;var _useMutation5=(0,_reactHooks.useMutation)(_queries.CREATE_PRESIGNED_URL),_useMutation6=(0,_slicedToArray2.default)(_useMutation5,1),createPresignedUrl=_useMutation6[0];var signFiles=function signFiles(files){return Promise.all(files.map(function(file){return(0,_fns.signFile)(file)(createPresignedUrl);}));};var onLoadStart=function onLoadStart(event){setLoadingPercent(0);console.log({onLoadStart:event});};var onLoadProgress=function onLoadProgress(event){console.log({onLoadProgress:event});var loaded=event.loaded,total=event.total;var normalPercent=Math.floor(loaded/total*100)/100;console.log({normalPercent:normalPercent});setLoadingPercent(normalPercent);};var uploadVideo=(0,_react.useCallback)(function _callee(fileBlob){var response;return _regenerator.default.async(function _callee$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return _regenerator.default.awrap(new Promise(function(resolve){var onLoadEnd=function onLoadEnd(event){console.log({onLoadEnd:event});setLoadingPercent(null);resolve(event);};var xhr=new XMLHttpRequest();xhr.upload.addEventListener('loadstart',onLoadStart,false);xhr.upload.addEventListener('progress',onLoadProgress,false);xhr.upload.addEventListener('load',onLoadEnd,false);xhr.open('PUT',fileBlob.presignedUrl);xhr.setRequestHeader('Content-type',fileBlob.type);xhr.setRequestHeader('X_FILE_NAME',fileBlob.name);xhr.send(fileBlob);}));case 3:response=_context2.sent;console.log({response:response});_context2.next=10;break;case 7:_context2.prev=7;_context2.t0=_context2["catch"](0);console.log({error:_context2.t0});case 10:case"end":return _context2.stop();}}},null,null,[[0,7]],Promise);},[]);var onFiles=function onFiles(files){var signedFiles,nextIndex,contentBlockImage,newTextBlock;return _regenerator.default.async(function onFiles$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:console.log({files:files});_context3.next=3;return _regenerator.default.awrap((0,_fns.convertFilesToBase64)(files));case 3:_context3.next=5;return _regenerator.default.awrap(signFiles(files));case 5:signedFiles=_context3.sent;console.log({signedFiles:signedFiles});nextIndex=state.activeIndex+1;dispatch({type:_state.ComposeActions.SET_TYPE,payload:'Image'});dispatch({type:_state.ComposeActions.SET_INDEX,payload:nextIndex});contentBlockImage={index:nextIndex,data:{index:nextIndex,type:'Image',files:signedFiles}};dispatch({type:_state.ComposeActions.SET_CONTENT,payload:contentBlockImage});newTextBlock={index:nextIndex+1,data:{index:nextIndex+1,type:'Text',text:''}};dispatch({type:_state.ComposeActions.SET_CONTENT,payload:newTextBlock});dispatch({type:_state.ComposeActions.SET_TYPE,payload:'Text'});dispatch({type:_state.ComposeActions.SET_INDEX,payload:nextIndex+1});case 16:case"end":return _context3.stop();}}},null,null,null,Promise);};var onVideoFiles=function onVideoFiles(files){var signedFiles,nextIndex,contentBlockVideo,newTextBlock;return _regenerator.default.async(function onVideoFiles$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log({files:files});_context4.next=3;return _regenerator.default.awrap(signFiles(files));case 3:signedFiles=_context4.sent;console.log({signedFiles:signedFiles});nextIndex=state.activeIndex+1;dispatch({type:_state.ComposeActions.SET_TYPE,payload:'Video'});dispatch({type:_state.ComposeActions.SET_INDEX,payload:nextIndex});contentBlockVideo={index:nextIndex,data:{index:nextIndex,type:'Video',files:signedFiles}};dispatch({type:_state.ComposeActions.SET_CONTENT,payload:contentBlockVideo});newTextBlock={index:nextIndex+1,data:{index:nextIndex+1,type:'Text',text:''}};dispatch({type:_state.ComposeActions.SET_CONTENT,payload:newTextBlock});dispatch({type:_state.ComposeActions.SET_TYPE,payload:'Text'});dispatch({type:_state.ComposeActions.SET_INDEX,payload:nextIndex+1});case 14:case"end":return _context4.stop();}}},null,null,null,Promise);};var onSubmit=function onSubmit(){var title,friendlyUrl,content,filesInPost,uploadedFiles,contentArray,input,_await$createPost,_data;return _regenerator.default.async(function onSubmit$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:title=state.title,friendlyUrl=state.friendlyUrl,content=state.content;filesInPost=Object.values(content).filter(contentMediaFilter);console.log({filesInPost:filesInPost});_context5.next=5;return _regenerator.default.awrap(Promise.all(filesInPost.map(function(content){if(content.type==='Video'){return uploadVideo(content.files[0]);}if(content.type==='Image'){return uploadImages(content.files);}return null;})));case 5:uploadedFiles=_context5.sent;console.log({uploadedFiles:uploadedFiles});contentArray=(0,_fns.formatContentForGraph)(content);console.log({contentArray:contentArray,title:title,friendlyUrl:friendlyUrl});input={content:contentArray};console.log({input:input});_context5.prev=11;_context5.next=14;return _regenerator.default.awrap(createPost({variables:{input:input}}));case 14:_await$createPost=_context5.sent;_data=_await$createPost.data;console.log('createPost data',_data);if(_data&&_data.CreatePost){toggleComposeModal();}_context5.next=23;break;case 20:_context5.prev=20;_context5.t0=_context5["catch"](11);console.log('createPostError',_context5.t0);case 23:case"end":return _context5.stop();}}},null,null,[[11,20]],Promise);};return _react.default.createElement(_.Modal,{open:open,onClose:toggleComposeModal,__self:_this,__source:{fileName:_jsxFileName,lineNumber:195,columnNumber:5}},_react.default.createElement(_ComposeBody.default,{state:state,dispatch:dispatch,loadingPercent:loadingPercent,__self:_this,__source:{fileName:_jsxFileName,lineNumber:196,columnNumber:7}}),_react.default.createElement(_ComposeToolbar.default,{onFiles:onFiles,onVideoFiles:onVideoFiles,onSubmit:onSubmit,loadingPercent:loadingPercent,__self:_this,__source:{fileName:_jsxFileName,lineNumber:201,columnNumber:7}}));};var _default=ComposeModal;exports.default=_default;