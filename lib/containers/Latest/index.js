var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.Latest=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _FlatList=_interopRequireDefault(require("react-native-web/dist/exports/FlatList"));var _RefreshControl=_interopRequireDefault(require("react-native-web/dist/exports/RefreshControl"));var _View=_interopRequireDefault(require("react-native-web/dist/exports/View"));var _components=require("../../components");var _theme2=require("../../theme");var _queries=require("../../queries");var _reactHooks=require("@apollo/react-hooks");var _state=require("../../state");var _this=this,_jsxFileName="/Users/kane/Lab/Eros/src/containers/Latest/index.js";var TIMELINE_LIMIT=5;var Latest=function Latest(_ref){var onPostPress=_ref.onPostPress;var _useTheme=(0,_theme2.useTheme)(),_useTheme2=(0,_slicedToArray2.default)(_useTheme,1),theme=_useTheme2[0];var gutter=theme.gutter,FEED_WIDTH=theme.FEED_WIDTH,textColor=theme.textColor;var options={variables:{offset:0,limit:5}};var _useQuery=(0,_reactHooks.useQuery)(_queries.TIMELINE,options),data=_useQuery.data,fetchMore=_useQuery.fetchMore,subscribeToMore=_useQuery.subscribeToMore;var latest=data&&data.Timeline;var posts=latest&&latest.posts;var _useState=(0,_react.useState)(false),_useState2=(0,_slicedToArray2.default)(_useState,2),refreshing=_useState2[0],setRefreshing=_useState2[1];var onLoadMore=function onLoadMore(){return fetchMore({query:_queries.TIMELINE,variables:{offset:data.Timeline.offset+TIMELINE_LIMIT,limit:TIMELINE_LIMIT},updateQuery:function updateQuery(prev,_ref2){var fetchMoreResult=_ref2.fetchMoreResult;var prevPosts=prev.Timeline.posts;var nextPosts=fetchMoreResult.Timeline.posts.reduce(function(acc,post){var indexFound=prevPosts.findIndex(function(prevPost){return prevPost.id===post.id;});if(indexFound===-1){return[].concat((0,_toConsumableArray2.default)(acc),[post]);}return acc;},[]);var offset=fetchMoreResult.Timeline.offset;return{Timeline:{offset:offset,posts:[].concat((0,_toConsumableArray2.default)(prevPosts),(0,_toConsumableArray2.default)(nextPosts)),__typename:prev.Timeline.__typename}};}});};var refresh=function refresh(){return fetchMore({query:_queries.TIMELINE,variables:{offset:0,limit:TIMELINE_LIMIT},updateQuery:function updateQuery(prev,_ref3){var fetchMoreResult=_ref3.fetchMoreResult;var prevPosts=prev.Timeline.posts;var nextPosts=fetchMoreResult.Timeline.posts.reduce(function(acc,post){var indexFound=prevPosts.findIndex(function(prevPost){return prevPost.id===post.id;});if(indexFound===-1){return[].concat((0,_toConsumableArray2.default)(acc),[post]);}return acc;},[]);var offset=fetchMoreResult.Timeline.offset;return{Timeline:{offset:offset,posts:[].concat((0,_toConsumableArray2.default)(nextPosts),(0,_toConsumableArray2.default)(prevPosts)),__typename:prev.Timeline.__typename}};}});};var subscribeToNewPosts=function subscribeToNewPosts(){return subscribeToMore({document:_queries.NEW_POST,updateQuery:function updateQuery(prev,_ref4){var subscriptionData=_ref4.subscriptionData;if(!subscriptionData.data){return prev;}var prevPosts=prev.Timeline.posts;var nextPost=subscriptionData.data.newPost;return{Timeline:(0,_extends2.default)({},prev.Timeline,{offset:prev.Timeline.offset+TIMELINE_LIMIT,posts:[nextPost].concat((0,_toConsumableArray2.default)(prevPosts)),__typename:prev.Timeline.__typename})};}});};var onEndReached=function onEndReached(e){return _regenerator.default.async(function onEndReached$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log('END_REACHED loadMore()');_context.next=3;return _regenerator.default.awrap(onLoadMore());case 3:case"end":return _context.stop();}}},null,null,null,Promise);};var onRefresh=function onRefresh(){return _regenerator.default.async(function onRefresh$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:setRefreshing(true);_context2.next=3;return _regenerator.default.awrap(refresh());case 3:setRefreshing(false);case 4:case"end":return _context2.stop();}}},null,null,null,Promise);};return _react.default.createElement(TimelineList,{posts:posts,onPostPress:onPostPress,onEndReached:onEndReached,onRefresh:onRefresh,refreshing:refreshing,subscribeToNewPosts:subscribeToNewPosts,__self:_this,__source:{fileName:_jsxFileName,lineNumber:112,columnNumber:5}});};exports.Latest=Latest;var TimelineList=function TimelineList(_ref5){var posts=_ref5.posts,onPostPress=_ref5.onPostPress,onEndReached=_ref5.onEndReached,onRefresh=_ref5.onRefresh,refreshing=_ref5.refreshing,subscribeToNewPosts=_ref5.subscribeToNewPosts,rest=(0,_objectWithoutProperties2.default)(_ref5,["posts","onPostPress","onEndReached","onRefresh","refreshing","subscribeToNewPosts"]);var _theme=theme,gutter=_theme.gutter,FEED_WIDTH=_theme.FEED_WIDTH,textColor=_theme.textColor;var _useDimensions=(0,_state.useDimensions)(),width=_useDimensions.width,mobile=_useDimensions.mobile;(0,_react.useEffect)(function(){subscribeToNewPosts();},[subscribeToNewPosts]);var _useMutation=(0,_reactHooks.useMutation)(_queries.SET_NAV_DOCKED),_useMutation2=(0,_slicedToArray2.default)(_useMutation,1),setNavDocked=_useMutation2[0];var onScroll=function onScroll(e){if(e.nativeEvent.contentOffset.y===0){return setNavDocked({variables:{docked:true}});}return setNavDocked({variables:{docked:false}});};var style={width:width-gutter*2,maxWidth:FEED_WIDTH,marginBottom:gutter};var _renderHeader=function _renderHeader(){return _react.default.createElement(_View.default,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:154,columnNumber:31}});};return _react.default.createElement(_FlatList.default,(0,_extends2.default)({testID:"Timeline",data:posts,renderItem:function renderItem(_ref6){var item=_ref6.item,key=_ref6.key;return _react.default.createElement(_components.Post,(0,_extends2.default)({key:item.id},item,{mobile:mobile,width:width,style:style,__self:_this,__source:{fileName:_jsxFileName,lineNumber:160,columnNumber:38}}));},refreshControl:_react.default.createElement(_RefreshControl.default,{refreshing:refreshing,onRefresh:onRefresh,tintColor:textColor.secondary,__self:_this,__source:{fileName:_jsxFileName,lineNumber:162,columnNumber:9}}),onEndReached:onEndReached,onEndReachedThreshold:0.5,keyExtractor:function keyExtractor(_ref7){var id=_ref7.id;return id;},contentContainerStyle:{alignItems:'center',width:'100%'},style:{flex:1,width:'100%'}},rest,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:157,columnNumber:5}}));};var _default=Latest;exports.default=_default;