var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.PhoneAuthSet=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _react=_interopRequireWildcard(require("react"));var _View=_interopRequireDefault(require("react-native-web/dist/exports/View"));var _reactHooks=require("@apollo/react-hooks");var _queries=require("../../queries");var _theme=require("../../theme");var _libphonenumberJs=require("libphonenumber-js");var _components=require("../../components");var _this=this,_jsxFileName="/Users/kane/Lab/Eros/src/containers/PhoneAuth/PhoneAuthSet.js";var PHONE_STATE={countryCode:'1',country:'US',phoneNumber:'',friendlyPhoneNumber:'',isPossible:false};var reducer=function reducer(state,action){switch(action.type){case'SET_PHONE_NUMBER':return(0,_extends2.default)({},state,{phoneNumber:action.payload,friendlyPhoneNumber:new _libphonenumberJs.AsYouType(state.country).input(action.payload)});case'SET_IS_POSSIBLE':return(0,_extends2.default)({},state,{isPossible:action.payload});default:throw"Action Type: "+action.type+" not found";}};var useSetPhoneMutation=function useSetPhoneMutation(){var client=(0,_reactHooks.useApolloClient)();var _useMutation=(0,_reactHooks.useMutation)(_queries.SET_PHONE,{onCompleted:function onCompleted(_ref){var phone=_ref.SetPhone;console.log('onCompleted phone',phone);client.writeQuery({query:_queries.PHONE,data:{Phone:(0,_extends2.default)({},phone)}});}}),_useMutation2=(0,_slicedToArray2.default)(_useMutation,2),setPhone=_useMutation2[0],state=_useMutation2[1];return[setPhone,state];};var PhoneAuthSet=function PhoneAuthSet(_ref2){var onSuccess=_ref2.onSuccess,handle=_ref2.handle,_ref2$onCountryCodePr=_ref2.onCountryCodePress,onCountryCodePress=_ref2$onCountryCodePr===void 0?function(){return null;}:_ref2$onCountryCodePr,_ref2$onNext=_ref2.onNext,onNext=_ref2$onNext===void 0?function(){return null;}:_ref2$onNext,_ref2$initialState=_ref2.initialState,initialState=_ref2$initialState===void 0?PHONE_STATE:_ref2$initialState;var _useReducer=(0,_react.useReducer)(reducer,initialState),_useReducer2=(0,_slicedToArray2.default)(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var _useSetPhoneMutation=useSetPhoneMutation(),_useSetPhoneMutation2=(0,_slicedToArray2.default)(_useSetPhoneMutation,2),setPhone=_useSetPhoneMutation2[0],_useSetPhoneMutation3=_useSetPhoneMutation2[1],data=_useSetPhoneMutation3.data,error=_useSetPhoneMutation3.error,loading=_useSetPhoneMutation3.loading;var handlePhone=function handlePhone(nextNumber){var nextPhoneNumber=nextNumber.replace(/\D/g,'');if(nextPhoneNumber.length===3&&state.phoneNumber.length===3){return dispatch({type:'SET_PHONE_NUMBER',payload:nextPhoneNumber.slice(0,2)});}return dispatch({type:'SET_PHONE_NUMBER',payload:nextPhoneNumber});};(0,_react.useEffect)(function(){if(state.phoneNumber.length===10){dispatch({type:'SET_IS_POSSIBLE',payload:true});}else{dispatch({type:'SET_IS_POSSIBLE',payload:false});}},[state.phoneNumber]);var submitPhone=function submitPhone(){var input,_await$setPhone,_data;return _regenerator.default.async(function submitPhone$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;input={countryCode:state.countryCode,number:state.phoneNumber};_context.next=4;return _regenerator.default.awrap(setPhone({variables:{input:input}}));case 4:_await$setPhone=_context.sent;_data=_await$setPhone.data;if(!(_data&&_data.SetPhone)){_context.next=8;break;}return _context.abrupt("return",onSuccess(_data.SetPhone));case 8:_context.next=13;break;case 10:_context.prev=10;_context.t0=_context["catch"](0);console.log('handlePhone catch',_context.t0.message);case 13:case"end":return _context.stop();}}},null,null,[[0,10]],Promise);};console.log('state',state);var isValid=state.isPossible;var styles=useStyles();return _react.default.createElement(_react.default.Fragment,null,_react.default.createElement(_View.default,{style:{width:'100%'},testID:"PhoneAuthSet",__self:_this,__source:{fileName:_jsxFileName,lineNumber:111,columnNumber:7}},_react.default.createElement(_components.Subtitle,{text:"Enter Phone Number",gutter:true,__self:_this,__source:{fileName:_jsxFileName,lineNumber:112,columnNumber:9}}),_react.default.createElement(_components.Row,{center:true,style:styles.row,__self:_this,__source:{fileName:_jsxFileName,lineNumber:113,columnNumber:9}},_react.default.createElement(_View.default,{style:styles.textFieldContainer,__self:_this,__source:{fileName:_jsxFileName,lineNumber:114,columnNumber:11}},_react.default.createElement(_components.TextField,{testID:"PhoneAuthSetInput",style:styles.textField,autoFocus:true,keyboardType:"phone-pad",keyboardAppearance:"dark",label:"phone",onChangeText:handlePhone,value:state.friendlyPhoneNumber,__self:_this,__source:{fileName:_jsxFileName,lineNumber:115,columnNumber:13}}))),error&&error.message&&_react.default.createElement(_components.Subtitle,{testID:"PhoneAuthSetError",text:error.message,gutter:true,__self:_this,__source:{fileName:_jsxFileName,lineNumber:128,columnNumber:11}}),loading&&_react.default.createElement(_components.ActivityIndicator,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:130,columnNumber:21}})),_react.default.createElement(_components.Container,{center:true,__self:_this,__source:{fileName:_jsxFileName,lineNumber:133,columnNumber:7}},_react.default.createElement(_components.OutlinedButton,{testID:"PhoneAuthSetPrimaryButton",disabled:!isValid,style:styles.button,text:"Continue",onPress:submitPhone,__self:_this,__source:{fileName:_jsxFileName,lineNumber:134,columnNumber:9}})));};exports.PhoneAuthSet=PhoneAuthSet;var useStyles=(0,_theme.makeStyles)(function(theme){return{container:{maxWidth:theme.FEED_WIDTH,padding:theme.NAV_HEIGHT,width:'100%',justifyContent:'center',alignItems:'center'},button:{flex:1,width:'100%'},row:{width:'100%',marginBottom:14},content:{flex:1},textField:{fontSize:21,lineHeight:31,alignItems:'center'},textFieldContainer:{width:'100%',flex:1}};});var _default=PhoneAuthSet;exports.default=_default;